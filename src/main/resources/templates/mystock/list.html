<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">

<head>
    <meta charset="UTF-8">
    <title>ë‚´ ì¢…ëª©</title>

    <style>
        .card-box {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 1.2rem;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        table th, table td {
            vertical-align: middle;
            font-size: 0.92rem;
        }

        .profit-row {
            background-color: #ffecec !important;
        }
        .loss-row {
            background-color: #e8f2ff !important;
        }

        /* í–‰ ì „ì²´ (ì—°í•œ ë°°ê²½ìƒ‰) */
        .profit-row {
            background-color: #ffe5e5; /* ì˜…ì€ ë¹¨ê°• */
        }

        .loss-row {
            background-color: #e8f0ff; /* ì˜…ì€ íŒŒë‘ */
        }

        .same-row {
            background-color: #f2f2f2; /* ì˜…ì€ íšŒìƒ‰ */
        }


        /* í˜„ì¬ê°€ í…ìŠ¤íŠ¸ ê°•ì¡° */
        .price-up {
            color: #d60000;
            font-weight: 600;
        }

        .price-down {
            color: #0049b7;
            font-weight: 600;
        }

        .price-same {
            color: #777;
            font-weight: 600;
        }


    </style>
</head>

<body>

<div layout:fragment="content" class="container mt-4" style="max-width:1400px;">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold">â­ ë‚´ ê´€ì‹¬ ì¢…ëª©</h3>

        <button class="btn btn-outline-secondary btn-sm"
                onclick="openHistoryModal()">
            ğŸ•‘ ì‚­ì œëœ ì¢…ëª© ë³´ê¸°
        </button>
    </div>

    <!-- ğŸ‡°ğŸ‡· í•œêµ­ ê´€ì‹¬ ì¢…ëª© -->
    <div th:if="${#lists.size(krList) > 0}">
        <h4 class="fw-bold mt-4">ğŸ‡°ğŸ‡· í•œêµ­ ê´€ì‹¬ ì¢…ëª©</h4>

        <div class="card card-box mb-5">
            <table class="table table-hover text-center table-sm">
                <thead class="table-light">
                <tr>
                    <th>No</th>
                    <th>ì¢…ëª©ì½”ë“œ</th>
                    <th>ì¢…ëª©ëª…</th>
                    <th>í˜„ì¬ê°€</th>
                    <th>ì¶”ê°€ ë‹¹ì‹œ ê°€ê²©</th>
                    <th>+5%</th>
                    <th>+10%</th>
                    <th>í¬ì°© ì „ëµ</th>
                    <th>ë“±ë¡ì¼</th>
                    <th>ì‚­ì œ</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="s, idx : ${krList}"
                    th:classappend="${
                    s.currentPrice > s.priceAtAdd ? 'profit-row' :
                    (s.currentPrice < s.priceAtAdd ? 'loss-row' : '')
                }">


                    <td th:text="${idx.index + 1}"></td>
                    <td th:text="${s.code}"></td>
                    <td th:text="${s.name}"></td>

                    <!-- í˜„ì¬ê°€ ìƒ‰ìƒ ê°•ì¡° -->
                    <td th:text="${#numbers.formatInteger(s.currentPrice, 0, 'COMMA') + ' ì›'}"
                        th:classappend="${
                        s.currentPrice > s.priceAtAdd ? 'price-up' :
                        (s.currentPrice < s.priceAtAdd ? 'price-down' : '')
                    }">
                    </td>

                    <td th:text="${#numbers.formatInteger(s.priceAtAdd, 0, 'COMMA') + ' ì›'}"></td>
                    <td th:text="${#numbers.formatInteger(s.targetPrice5, 0, 'COMMA') + ' ì›'}"></td>
                    <td th:text="${#numbers.formatInteger(s.targetPrice10, 0, 'COMMA') + ' ì›'}"></td>

                    <td>
                        <span th:text="${T(com.stock.managing.enums.StrategyCode).findByCode(s.strategyName).label}"></span>
                        <a th:href="@{'/board/detailKR'(strategy=${s.strategyName}, date=${s.memo})}">ğŸ”</a>
                    </td>

                    <td th:text="${#temporals.format(s.createdAt, 'yyyy-MM-dd')}"></td>

                    <td>
                        <button class="btn btn-sm btn-outline-danger"
                                th:onclick="'deleteMyStock(' + ${s.id} + ')'">ì‚­ì œ</button>
                    </td>

                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ê´€ì‹¬ ì¢…ëª© -->
    <div th:if="${#lists.size(usList) > 0}">
        <h4 class="fw-bold mt-4">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ê´€ì‹¬ ì¢…ëª©</h4>

        <div class="card card-box mb-5">
            <table class="table table-hover text-center table-sm">
                <thead class="table-light">
                <tr>
                    <th>No</th>
                    <th>ì¢…ëª©ì½”ë“œ</th>
                    <th>ì¢…ëª©ëª…</th>
                    <th>í˜„ì¬ê°€</th>
                    <th>ì¶”ê°€ ë‹¹ì‹œ ê°€ê²©</th>
                    <th>+5%</th>
                    <th>+10%</th>
                    <th>í¬ì°© ì „ëµ</th>
                    <th>ë“±ë¡ì¼</th>
                    <th>ì‚­ì œ</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="s, idx : ${usList}"
                    th:classappend="${
                    s.currentPrice > s.priceAtAdd ? 'profit-row' :
                    (s.currentPrice < s.priceAtAdd ? 'loss-row' : '')
                }">


                <td th:text="${idx.index + 1}"></td>
                    <td th:text="${s.code}"></td>
                    <td th:text="${s.name}"></td>

                    <!-- í˜„ì¬ê°€ â†’ ë¹¨ê°•/íŒŒë‘ ê°•ì¡° -->
                    <td th:text="${s.currentPrice + ' $'}"
                            th:classappend="${
                            s.currentPrice > s.priceAtAdd ? 'price-up' :
                            (s.currentPrice < s.priceAtAdd ? 'price-down' : '')
                        }">
                    </td>


                    <td th:text="${s.priceAtAdd + ' $'}"></td>
                    <td th:text="${s.targetPrice5 + ' $'}"></td>
                    <td th:text="${s.targetPrice10 + ' $'}"></td>

                    <td>
                        <span th:text="${T(com.stock.managing.enums.StrategyCode).findByCode(s.strategyName).label}"></span>
                        <a th:href="@{'/board/detailUS'(strategy=${s.strategyName}, date=${s.memo})}">ğŸ”</a>
                    </td>

                    <td th:text="${#temporals.format(s.createdAt, 'yyyy-MM-dd')}"></td>

                    <td>
                        <button class="btn btn-sm btn-outline-danger"
                                th:onclick="'deleteMyStock(' + ${s.id} + ')'">ì‚­ì œ</button>
                    </td>
                </tr>
                </tbody>


            </table>
        </div>
    </div>

    <!-- ì‚­ì œ ëª¨ë‹¬ -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">ğŸ•‘ ì‚­ì œëœ ê´€ì‹¬ ì¢…ëª©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <table class="table table-sm table-hover text-center">
                        <thead class="table-light">
                        <tr>
                            <th>No</th>
                            <th>ì¢…ëª©ì½”ë“œ</th>
                            <th>ì¢…ëª©ëª…</th>
                            <th>ì‚­ì œì¼</th>
                            <th>ë³µêµ¬</th>
                        </tr>
                        </thead>
                        <tbody id="deletedListBody"></tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="script">
    <script th:inline="javascript">

        document.addEventListener("DOMContentLoaded", function () {

            window.deleteMyStock = function (id) {
                if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

                fetch("/mystock/delete/" + id, {method: "POST"})
                    .then(res => res.json())
                    .then(() => {
                        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤");
                        location.reload();
                    });
            }

            window.openHistoryModal = function () {
                fetch("/mystock/deleted")
                    .then(res => res.json())
                    .then(list => {

                        const tbody = document.getElementById("deletedListBody");
                        tbody.innerHTML = "";

                        list.forEach((s, idx) => {
                            tbody.innerHTML += `
                            <tr>
                                <td>${idx + 1}</td>
                                <td>${s.code}</td>
                                <td>${s.name}</td>
                                <td>${s.deletedAt.replace("T", " ")}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary"
                                        onclick="restoreMyStock(${s.id})">
                                        ë³µêµ¬
                                    </button>
                                </td>
                            </tr>`;
                        });

                        new bootstrap.Modal(document.getElementById("historyModal")).show();
                    });
            }

            window.restoreMyStock = function (id) {
                if (!confirm("ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

                fetch("/mystock/restore/" + id, {method: "POST"})
                    .then(res => res.json())
                    .then(() => {
                        alert("ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤!");

                        let modal = bootstrap.Modal.getInstance(document.getElementById("historyModal"));
                        modal.hide();
                        setTimeout(() => location.reload(), 200);
                    });
            }
        });

    </script>
</th:block>

</body>
</html>
