<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">

<style>
  .table-danger {
    --bs-table-bg: #fff5f5;
  }

  .table-primary {
    --bs-table-bg: #f2f6ff;
  }
</style>
<body>
<div layout:fragment="content"
     class="container mt-4"
     style="max-width:1200px;">

  <!-- =========================
       ETF í—¤ë” ì˜ì—­
       ========================= -->
  <div class="d-flex justify-content-between align-items-start mb-4">
    <div>
      <h3 class="fw-bold mb-1" th:text="${etfName}">ETF ì´ë¦„</h3>

      <div th:if="${etfDescription != null and !#strings.isEmpty(etfDescription)}"
           class="px-3 py-2 mt-2"
           style="background:#f8f9fa;border-left:4px solid #0d6efd;
              border-radius:4px;font-size:0.9rem;color:#555;">
        <span th:text="${etfDescription}">ETF ì„¤ëª…</span>
      </div>

      <div class="mt-2">
        <button class="btn btn-sm btn-outline-secondary" onclick="goBack()">
          â† ì´ì „ í™”ë©´ ê°€ê¸°
        </button>
      </div>
    </div>

    <div class="d-flex gap-2 mt-1">
      <button class="btn btn-outline-primary btn-sm"
              data-bs-toggle="modal"
              data-bs-target="#editEtfModal">
        ì¢…ëª© í¸ì§‘
      </button>

      <button class="btn btn-outline-secondary btn-sm"
              onclick="openRestoreModal()">
        ì¢…ëª© ë³µêµ¬
      </button>
    </div>
  </div>
  <!-- =========================
      ğŸ”¥ ETF ìš”ì•½ ì˜ì—­
      ========================= -->
  <div class="card mb-3">
    <div class="card-body py-3">
      <div class="row text-center">

        <div class="col">
          <div class="text-muted small">ì´ í¸ì…ê¸ˆì•¡</div>
          <div class="fw-bold"
               th:text="${#numbers.formatInteger(summary.totalInvested,0,'COMMA')} + 'ì›'">
            0ì›
          </div>
        </div>

        <div class="col">
          <div class="text-muted small">í˜„ì¬ í‰ê°€ì•¡</div>
          <div class="fw-bold"
               th:text="${#numbers.formatInteger(summary.totalEvaluated,0,'COMMA')} + 'ì›'">
            0ì›
          </div>
        </div>

        <div class="col">
          <div class="text-muted small">ìˆ˜ìµê¸ˆ</div>
          <div class="fw-bold"
               th:classappend="
        ${summary.totalEvaluated > summary.totalInvested} ? 'text-danger' :
        (${summary.totalEvaluated < summary.totalInvested} ? 'text-primary' : '')
     "
               th:text="${#numbers.formatInteger(summary.profitAmount,0,'COMMA')} + 'ì›'">
          </div>
        </div>

        <div class="col">
          <div class="text-muted small">ìˆ˜ìµë¥ </div>
          <div class="fw-bold"
               th:classappend="
        ${summary.totalEvaluated > summary.totalInvested} ? 'text-danger' :
        (${summary.totalEvaluated < summary.totalInvested} ? 'text-primary' : '')
     "
               th:text="${#numbers.formatDecimal(summary.profitRate,1,2)} + '%'">
          </div>

        </div>

      </div>
    </div>
  </div>


  <!-- =========================
       ETF êµ¬ì„± ì¢…ëª©
       ========================= -->
  <div class="card card-box">
    <div class="card-header bg-white fw-bold">êµ¬ì„± ì¢…ëª©</div>

    <div class="card-body p-0">
      <table class="table table-hover text-center mb-0">
        <thead class="table-light">
        <tr>
          <th style="width:60px;">No</th>
          <th>ì¢…ëª©ì½”ë“œ</th>
          <th>ì¢…ëª©ëª…</th>
          <th>ìˆ˜ëŸ‰</th>
          <th>í¸ì…ê°€</th>
          <th>í˜„ì¬ê°€</th>
          <th>í‰ê°€ê¸ˆì•¡</th>
          <th>ìˆ˜ìµë¥ </th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="s, idx : ${itemList}">
        <td th:text="${idx.index + 1}"></td>
          <td th:text="${s.code}"></td>
          <td th:text="${s.name}"></td>
          <td th:text="${s.quantity}"></td>
          <td th:text="${s.priceAtAddDisplay}"></td>
          <td th:text="${s.currentPriceDisplay}"
              th:classappend="
        ${s.evaluatedAmount > (s.priceAtAdd * s.quantity)} ? 'text-danger fw-bold' :
        (${s.evaluatedAmount < (s.priceAtAdd * s.quantity)} ? 'text-primary fw-bold' : 'fw-bold')
    ">
          </td>
          <td th:text="${s.evaluatedAmountDisplay}"></td>
          <td th:text="${s.profitRateDisplay}"
              th:classappend="
                              ${s.evaluatedAmount > (s.priceAtAdd * s.quantity)} ? 'text-danger fw-bold' :
                              (${s.evaluatedAmount < (s.priceAtAdd * s.quantity)} ? 'text-primary fw-bold' : '')
                          ">
          </td>


        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- =========================
       ETF ì¢…ëª© í¸ì§‘ ëª¨ë‹¬
       ========================= -->
  <div class="modal fade" id="editEtfModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">ETF ì¢…ëª© í¸ì§‘</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label fw-bold">ETF ì´ë¦„</label>
            <input type="text" class="form-control"
                   th:value="${etfName}" readonly>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">ETF ì„¤ëª…</label>
            <textarea class="form-control" rows="2"
                      id="etfDescription"
                      th:text="${etfDescription}"></textarea>

          </div>

          <hr/>

          <h6 class="fw-bold mb-2">ì¢…ëª© ê²€ìƒ‰</h6>
          <div class="mb-3">
            <input type="text" id="searchKeyword" class="form-control"
                   placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì¢…ëª©ì½”ë“œ">
          </div>

          <div style="max-height:200px; overflow-y:auto; border:1px solid #dee2e6;">
            <table class="table table-sm text-center mb-0">
              <thead class="table-light" style="position:sticky; top:0;">
              <tr>
                <th>ì¢…ëª©ëª…</th>
                <th>ì¢…ëª©ì½”ë“œ</th>
                <th>ì¶”ê°€</th>
              </tr>
              </thead>
              <tbody id="searchResultBody"></tbody>
            </table>
          </div>

          <hr/>

          <h6 class="fw-bold mb-2">êµ¬ì„± ì¢…ëª©</h6>
          <table class="table table-sm text-center">
            <thead class="table-light">
            <tr>
              <th>No</th>
              <th>ì¢…ëª©ëª…</th>
              <th>ì¢…ëª©ì½”ë“œ</th>
              <th>ìˆ˜ëŸ‰</th>
              <th>ì‚­ì œ</th>
            </tr>
            </thead>
            <tbody id="tempItemBody"></tbody>
          </table>

        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button class="btn btn-primary" onclick="saveEtfEdit()">ì €ì¥</button>
        </div>

      </div>
    </div>
  </div>

  <!-- =========================
       ETF ì¢…ëª© ë³µêµ¬ ëª¨ë‹¬
       ========================= -->
  <div class="modal fade" id="restoreEtfModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">ì‚­ì œëœ ì¢…ëª© ë³µêµ¬</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <p class="small text-muted mb-3">
            ì‚­ì œëœ ì¢…ëª© ì¤‘ ë³µêµ¬í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.
          </p>

          <table class="table table-sm text-center">
            <thead class="table-light">
            <tr>
              <th>No</th>
              <th>ì¢…ëª©ëª…</th>
              <th>ì¢…ëª©ì½”ë“œ</th>
              <th>ì‚­ì œì¼</th>
              <th>ë³µêµ¬</th>
            </tr>
            </thead>
            <tbody id="restoreItemBody">
            <tr>
              <td colspan="5" class="text-muted">
                ë³µêµ¬ ê°€ëŠ¥í•œ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤
              </td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- =========================
     Script
     ========================= -->
<th:block layout:fragment="script">
  <script th:inline="javascript">
    let tempItems = [];
    const BASE = "/board";

    /*<![CDATA[*/
    tempItems = [[${itemList}]].map(i => ({
      id: i.id,
      code: i.code,
      name: i.name,
      quantity: i.quantity,
      originalQuantity: i.quantity, // â­ ì¶”ê°€
      deleted: false
    }));
    /*]]>*/

    renderTempItems();

    document.getElementById("searchKeyword").addEventListener("keyup", function () {
      const q = this.value.trim();
      if (!q) return document.getElementById("searchResultBody").innerHTML = "";

      fetch(`${BASE}/autocomplete?q=${encodeURIComponent(q)}`)
              .then(res => res.json())
              .then(renderSearchResult);
    });

    function renderSearchResult(list) {
      const body = document.getElementById("searchResultBody");
      body.innerHTML = list.length === 0
              ? `<tr><td colspan="3" class="text-muted">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</td></tr>`
              : list.map(i => `
        <tr>
          <td>${i.name}</td>
          <td>${i.code}</td>
          <td>
            <button class="btn btn-sm btn-outline-success"
                    onclick="addTempItem('${i.code}','${i.name}')">
              ì¶”ê°€
            </button>
          </td>
        </tr>`).join("");
    }

    function addTempItem(code, name) {
      const exist = tempItems.find(i => i.code === code && !i.deleted);
      exist ? exist.quantity++ :
              tempItems.push({ id:null, code, name, quantity:1, deleted:false });
      renderTempItems();
    }

    function removeTempItem(idx) {
      tempItems[idx].deleted = true;
      renderTempItems();
    }

    function renderTempItems() {
      const body = document.getElementById("tempItemBody");
      body.innerHTML = "";

      tempItems.forEach((i, realIdx) => {
        if (i.deleted) return;

        body.innerHTML += `
      <tr>
        <td>${realIdx + 1}</td>
        <td>${i.name}</td>
        <td>${i.code}</td>
        <td>
          <input type="number" min="1" value="${i.quantity}"
                 onchange="tempItems[${realIdx}].quantity=this.value">
        </td>
        <td>
          <button class="btn btn-sm btn-outline-danger"
                  onclick="removeTempItem(${realIdx})">ì‚­ì œ</button>
        </td>
      </tr>`;
      });
    }

    const etfName = /*[[${etfName}]]*/;

    function saveEtfEdit() {

      const invalidItems = tempItems.filter(i =>
              i.id !== null &&               // ê¸°ì¡´ ì¢…ëª©
              !i.deleted &&                  // ì‚­ì œ ì•„ë‹˜
              Number(i.quantity) !== Number(i.originalQuantity)
      );

      if (invalidItems.length > 0) {

        // ğŸ”¥ ì—¬ê¸°ì„œ í™”ë©´ ê°’ ë˜ëŒë¦¬ê¸°
        invalidItems.forEach(i => {
          i.quantity = i.originalQuantity;
        });

        // ğŸ”„ í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¼
        renderTempItems();

        alert(
                "ì´ë¯¸ ê¸°ë“±ë¡ëœ ì¢…ëª©ì— ëŒ€í•´ì„œëŠ” ìˆ˜ëŸ‰ì„ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n" +
                "ì‚­ì œ í›„ ì¬ë“±ë¡ ë°”ëë‹ˆë‹¤."
        );
        return;
      }

      fetch("/myetf/edit", {
        method: "POST",
        headers: {
          "Content-Type": "application/json; charset=UTF-8"
        },
        body: JSON.stringify({
          etfName: etfName, // â­ ì´ë¯¸ ì„ ì–¸ëœ ë³€ìˆ˜ ì‚¬ìš©
          etfDescription: document.getElementById("etfDescription").value,
          items: tempItems
        })
      })
              .then(res => {
                if (!res.ok) {
                  return res.text().then(t => {
                    throw new Error(t || "ì €ì¥ ì‹¤íŒ¨");
                  });
                }
              })
              .then(() => location.reload())
              .catch(err => alert(err.message));
    }






    function openRestoreModal() {

      fetch(`/myetf/history?etfName=${encodeURIComponent(etfName)}`)
              .then(res => res.json())
              .then(list => {

                const body = document.getElementById("restoreItemBody");
                body.innerHTML = "";

                if (!list || list.length === 0) {
                  body.innerHTML = `
          <tr>
            <td colspan="5" class="text-muted">
              ë³µêµ¬ ê°€ëŠ¥í•œ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤
            </td>
          </tr>`;
                } else {
                  list.forEach((item, idx) => {
                    body.innerHTML += `
            <tr>
              <td>${idx + 1}</td>
              <td>${item.name}</td>
              <td>${item.code}</td>
              <td>${item.deletedAt.replace("T"," ")}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary"
                        onclick="restoreItem(${item.histId})">
                  ë³µêµ¬
                </button>
              </td>
            </tr>`;
                  });
                }

                new bootstrap.Modal(
                        document.getElementById("restoreEtfModal")
                ).show();
              });
    }


    function restoreItem(histId) {
      if (!confirm("ì´ ì¢…ëª©ì„ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      fetch("/myetf/restore", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          historyIds: [histId]
        })
      })
              .then(res => {
                if (!res.ok) throw new Error();
                alert("ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤");
                location.reload();
              });
    }

    function goBack() {
      window.history.back();
    }

  </script>
</th:block>

</body>
</html>
