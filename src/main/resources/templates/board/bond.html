<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
    <meta charset="UTF-8">
    <title>국채 금리 차트</title>

    <link rel="stylesheet" th:href="@{/css/markdown.css}">

    <style>
        .card { margin-bottom: 0 !important; }
        .chart-container { width: 100%; height: 360px; }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr;   /* ← 2열 → 1열 */
            gap: 1.5rem;
        }
        .chart-range .btn.active {
            background-color: #0d6efd !important;
            color: #fff !important;
        }
        .latest-info {
            display: flex;
            gap: 16px;       /* 항목 간 간격 */
            flex-wrap: wrap; /* 화면 좁으면 자동 줄바꿈 */
            align-items: center;
        }
        .up { color: #d93025 !important; }
        .down { color: #1a73e8 !important; }
        .latest-info span {
            margin-right: 12px;   /* 항목 간 간격 */
        }
        .base-date {
            font-size: 0.75rem;
            color: #666;
            margin-left: 10px;
        }

    </style>
</head>

<body>
<div layout:fragment="content" class="container mt-4">

    <h3 class="fw-bold mb-4">국채 금리 차트</h3>

    <div class="grid-container">

        <!-- ================== 미국 ================== -->
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold">미국 국채 금리</span>
                <span class="latest-info" data-id="us"></span>
                <span class="base-date" data-id="us"></span>
                <div class="btn-group btn-group-sm chart-range" data-target="us">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="us"></canvas>
            </div>
        </div>

        <!-- ================== 한국 ================== -->
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold">한국 국채 금리</span>
                <span class="latest-info" data-id="kr"></span>
                <span class="base-date" data-id="kr"></span>
                <div class="btn-group btn-group-sm chart-range" data-target="kr">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="kr"></canvas>
            </div>
        </div>

        <!-- ================== 일본 ================== -->
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold">일본 국채 금리</span>
                <span class="latest-info" data-id="jp"></span>
                <span class="base-date" data-id="jp"></span>
                <div class="btn-group btn-group-sm chart-range" data-target="jp">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="jp"></canvas>
            </div>
        </div>

        <!-- ================== 중국 ================== -->
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold">중국 국채 금리</span>
                <span class="latest-info" data-id="cn"></span>
                <span class="base-date" data-id="cn"></span>
                <div class="btn-group btn-group-sm chart-range" data-target="cn">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="cn"></canvas>
            </div>
        </div>

    </div>

</div>
<th:block layout:fragment="script">
    <script th:src="@{/js/chart/chart.umd.min.js}"></script>
    <script th:src="@{/js/chart/chartjs-adapter-date-fns.bundle.min.js}"></script>

    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", () => {

            // 각 국가별 데이터
            const raw = {
                us: {
                    us2y:  /*[[${us2y}]]*/ [],
                    us5y:  /*[[${us5y}]]*/ [],
                    us10y: /*[[${us10y}]]*/ [],
                    us30y: /*[[${us30y}]]*/ []
                },
                kr: {
                    kr3y:  /*[[${kr3y}]]*/ [],
                    kr5y:  /*[[${kr5y}]]*/ [],
                    kr10y: /*[[${kr10y}]]*/ [],
                    kr30y: /*[[${kr20y}]]*/ []
                },
                jp: {
                    jp2y:  /*[[${jp2y}]]*/ [],
                    jp5y:  /*[[${jp5y}]]*/ [],
                    jp10y: /*[[${jp10y}]]*/ [],
                    jp30y: /*[[${jp30y}]]*/ []
                },
                cn: {
                    cn1y:  /*[[${cn1y}]]*/ [],
                    cn3y:  /*[[${cn3y}]]*/ [],
                    cn5y:  /*[[${cn5y}]]*/ [],
                    cn10y: /*[[${cn10y}]]*/ []
                }
            };

            // 만기 라벨
            const labelMap = {
                us2y: "미국 2년물",
                us5y: "미국 5년물",
                us10y: "미국 10년물",
                us30y: "미국 30년물",

                kr3y: "한국 3년물",
                kr5y: "한국 5년물",
                kr10y:"한국 10년물",
                kr30y:"한국 30년물",

                jp2y:"일본 2년물",
                jp5y:"일본 5년물",
                jp10y:"일본 10년물",
                jp30y:"일본 30년물",

                cn1y:"중국 1년물",
                cn3y:"중국 3년물",
                cn5y:"중국 5년물",
                cn10y:"중국 10년물"
            };

            // 색상 자동 생성
            const colorMap = {
                // 미국 (블루 계열)
                us2y:  { border: "#1E3A8A", bg: "rgba(30,58,138,0.15)" },
                us5y:  { border: "#3B82F6", bg: "rgba(59,130,246,0.15)" },
                us10y: { border: "#60A5FA", bg: "rgba(96,165,250,0.15)" },
                us30y:{ border: "#93C5FD", bg: "rgba(147,197,253,0.15)" },

                // 한국 (청록 계열)
                kr3y:  { border: "#0D9488", bg: "rgba(13,148,136,0.15)" },
                kr5y:  { border: "#14B8A6", bg: "rgba(20,184,166,0.15)" },
                kr10y: { border: "#2DD4BF", bg: "rgba(45,212,191,0.15)" },
                kr30y: { border: "#99F6E4", bg: "rgba(153,246,228,0.15)" },

                // 일본 (레드 계열)
                jp2y:  { border: "#991B1B", bg: "rgba(153,27,27,0.15)" },
                jp5y:  { border: "#DC2626", bg: "rgba(220,38,38,0.15)" },
                jp10y: { border: "#F87171", bg: "rgba(248,113,113,0.15)" },
                jp30y: { border: "#FECACA", bg: "rgba(254,202,202,0.15)" },

                // 중국 (골드 계열)
                cn1y:  { border: "#92400E", bg: "rgba(146,64,14,0.15)" },
                cn3y:  { border: "#B45309", bg: "rgba(180,83,9,0.15)" },
                cn5y:  { border: "#D97706", bg: "rgba(217,119,6,0.15)" },
                cn10y: { border: "#FBBF24", bg: "rgba(251,191,36,0.15)" }
            };



            // 날짜 변환
            function convert(list) {
                return list.map(v => {
                    const [y,m,d] = v.date.split("-");
                    return {
                        x: new Date(y, m-1, d),
                        y: Number(v.close)
                    };
                });
            }

            const chartMap = {};

            // 국가별 차트 생성
            Object.keys(raw).forEach(country => {

                const ctx = document.getElementById(country);
                const countryData = raw[country];

                const datasets = Object.keys(countryData).map(key => {
                    const c = colorMap[key];   //  국가별 고정 색상 사용

                    return {
                        label: labelMap[key],
                        data: convert(countryData[key]),
                        borderColor: c.border,
                        backgroundColor: c.bg,
                        tension: 0.15,
                        pointRadius: 0,
                        fill: true
                    };
                });

                const now = new Date();
                const from = new Date();
                from.setMonth(now.getMonth() - 3);

                chartMap[country] = new Chart(ctx, {
                    type: "line",
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,

                        interaction: {
                            mode: "nearest",
                            intersect: false
                        },

                        plugins: {
                            legend: { display: true, position: "top" },
                            tooltip: {
                                enabled: true,
                                mode: "nearest",
                                intersect: false,
                                backgroundColor: "rgba(0,0,0,0.85)",
                                displayColors: false,
                                callbacks: {
                                    title: ctx => {
                                        const dt = new Date(ctx[0].parsed.x);
                                        return dt.toISOString().slice(0, 10);
                                    },
                                    label: ctx => {
                                        return `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`;
                                    }
                                }
                            }
                        },

                        scales: {
                            x: {
                                type: "time",
                                time: { unit: "day", displayFormats:{ day:"yyyy-MM-dd" } },
                                min: from,
                                max: now,
                                grid: { display: false }
                            },
                            y: {
                                ticks: {
                                    callback: v => v.toFixed(2) + "%"
                                },
                                grid: { display: false }
                            }
                        }
                    }
                });

            });


            // 기간 버튼
            document.querySelectorAll(".chart-range button").forEach(btn => {
                btn.addEventListener("click", () => {

                    const target = btn.closest(".chart-range").dataset.target;
                    const chart = chartMap[target];
                    const range = btn.dataset.range;

                    const now = new Date();
                    const from = new Date();

                    if (range === "1m") from.setMonth(now.getMonth() - 1);
                    else if (range === "3m") from.setMonth(now.getMonth() - 3);
                    else if (range === "6m") from.setMonth(now.getMonth() - 6);
                    else if (range === "1y") from.setFullYear(now.getFullYear() - 1);

                    chart.options.scales.x.min = from;
                    chart.options.scales.x.max = now;
                    chart.update();

                    btn.closest(".chart-range").querySelectorAll("button")
                        .forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                });
            });


            // 최신 금리 패널 업데이트
            Object.keys(raw).forEach(country => {

                const group = raw[country];
                const tag = document.querySelector(`.latest-info[data-id="${country}"]`);
                if (!tag) return;

                let html = "";

                Object.keys(group).forEach(key => {
                    const arr = group[key];
                    if (arr.length < 2) return;

                    const last = arr[arr.length - 1];
                    const prev = arr[arr.length - 2];

                    const diff = last.close - prev.close;
                    const arrow = diff > 0 ? "▲" : diff < 0 ? "▼" : "";
                    const cls = diff > 0 ? "up" : "down";

                    html += `
                            <span>
                                ${labelMap[key]} ${last.close.toFixed(2)}%
                                <span class="${cls}">${arrow}</span>
                            </span>
                        `;
                });

                tag.innerHTML = html;
            });

            // 기준일 업데이트
            Object.keys(raw).forEach(country => {

                const group = raw[country];
                const baseTag = document.querySelector(`.base-date[data-id="${country}"]`);
                if (!baseTag) return;

                // 모든 만기 데이터 중 가장 최신 날짜 하나만 선택
                let lastDate = null;

                Object.keys(group).forEach(key => {
                    const arr = group[key];
                    if (!arr || arr.length === 0) return;

                    const dt = arr[arr.length - 1].date;  // yyyy-MM-dd
                    if (!lastDate || dt > lastDate) lastDate = dt;
                });

                baseTag.textContent = `기준일: ${lastDate}`;
            });



        });
    </script>
</th:block>
