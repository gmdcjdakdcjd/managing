<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
    <meta charset="UTF-8">
    <title>ÏßÄÌëú Ï∞®Ìä∏</title>

    <link rel="stylesheet" th:href="@{/css/markdown.css}">

    <style>
        .card { margin-bottom: 0 !important; }
        .chart-container {
            position: relative;
            width: 100%;
            height: 380px;
        }

        /* Í∞úÎ≥Ñ Ïπ¥Îìú ÎÇ¥ Í∏∞Í∞ÑÎ≤ÑÌäº */
        .chart-range .btn.active {
            background-color: #0d6efd !important;
            color: white !important;
        }

        /* 2Ïó¥ Í∑∏Î¶¨Îìú */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .latest-info {
            font-size: 0.85rem;
            min-width: 90px;
            color: #333;
        }
        .latest-info.up {
            color: #d93025;  /* ÏÉÅÏäπ: Îπ®Í∞ï */
            font-weight: 600;
        }
        .latest-info.down {
            color: #1a73e8; /* ÌïòÎùΩ: ÌååÎûë */
            font-weight: 600;
        }

        .latest-date {
            font-size: 0.7rem;
            color: #666;
        }
    </style>
</head>

<body>
<div layout:fragment="content" class="container mt-4">

    <h3 class="fw-bold mb-4">üìä ÏãúÏû• ÏßÄÌëú Ï∞®Ìä∏</h3>

    <div id="extraCharts" class="grid-container">

        <!-- 8Í∞ú Ï∞®Ìä∏ Í≥µÌÜµ Íµ¨Ï°∞ -->
        <!-- KOSPI -->
        <!-- KOSPI -->
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold">KOSPI</span>

                <!-- ÏµúÏã† Í∞ÄÍ≤©/Îì±ÎùΩÎ•† -->
                <span class="latest-info text-end" data-id="kospi"></span>

                <div class="btn-group btn-group-sm chart-range" data-target="kospi">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="kospi"></canvas>
            </div>
        </div>

        <!-- SPX -->
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold">S&P500</span>
                <span class="latest-info text-end" data-id="spx"></span>
                <div class="btn-group btn-group-sm chart-range" data-target="spx">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="spx"></canvas>
            </div>
        </div>

        <!-- USD -->
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold">USD</span>
                <span class="latest-info text-end" data-id="usd"></span>
                <div class="btn-group btn-group-sm chart-range" data-target="usd">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="usd"></canvas>
            </div>
        </div>

        <!-- JPY -->
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold">JPY</span>
                <span class="latest-info text-end" data-id="jpy"></span>
                <div class="btn-group btn-group-sm chart-range" data-target="jpy">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="jpy"></canvas>
            </div>
        </div>

        <!-- Í∏à KR -->
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold">Í∏à(KR)</span>
                <span class="latest-info text-end" data-id="goldKr"></span>
                <div class="btn-group btn-group-sm chart-range" data-target="goldKr">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="goldKr"></canvas>
            </div>
        </div>

        <!-- Gold(Global) -->
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold">Gold(Global)</span>
                <span class="latest-info text-end" data-id="goldGl"></span>
                <div class="btn-group btn-group-sm chart-range" data-target="goldGl">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="goldGl"></canvas>
            </div>
        </div>

        <!-- WTI -->
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold">WTI</span>
                <span class="latest-info text-end" data-id="wti"></span>
                <div class="btn-group btn-group-sm chart-range" data-target="wti">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="wti"></canvas>
            </div>
        </div>

        <!-- Dubai -->
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold">Dubai Oil</span>
                <span class="latest-info text-end" data-id="dubai"></span>
                <div class="btn-group btn-group-sm chart-range" data-target="dubai">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="dubai"></canvas>
            </div>
        </div>


    </div>
</div>

<th:block layout:fragment="script">
    <script th:src="@{/js/chart/chart.umd.min.js}"></script>
    <script th:src="@{/js/chart/chartjs-adapter-date-fns.bundle.min.js}"></script>

    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", () => {

            // =======================
            // Îç∞Ïù¥ÌÑ∞
            // =======================
            const datasets = {
                kospi:  /*[[${kospiList}]]*/ [],
                spx:    /*[[${spxList}]]*/ [],
                usd:    /*[[${usdList}]]*/ [],
                jpy:    /*[[${jpyList}]]*/ [],
                goldKr: /*[[${goldKrList}]]*/ [],
                goldGl: /*[[${goldGlobalList}]]*/ [],
                wti:    /*[[${wtiList}]]*/ [],
                dubai:  /*[[${dubaiList}]]*/ []
            };

            const labels = {
                kospi: "KOSPI",
                spx:   "S&P500",
                usd:   "USD",
                jpy:   "JPY",
                goldKr: "Í∏à(KR)",
                goldGl: "Gold(Global)",
                wti: "WTI",
                dubai: "Dubai Oil"
            };

            const usdSet = {
                kospi:false, spx:true, usd:true, jpy:true,
                goldKr:false, goldGl:true, wti:true, dubai:true
            };

            // ÎÇ†Ïßú Î≥ÄÌôò
            function convertData(list) {
                return list.map(item => {
                    const [y, m, d] = item.date.split("-");
                    return {
                        x: new Date(Date.UTC(y, m - 1, d)),  // ‚Üê ÎÇ†Ïßú Î∞ÄÎ¶º Ìï¥Í≤∞
                        y: Number(item.close)
                    };
                });
            }

            const colors = {
                kospi:  { border: "#2E86DE", background: "rgba(46,134,222,0.25)" },
                spx:    { border: "#E74C3C", background: "rgba(231,76,60,0.25)" },
                usd:    { border: "#27AE60", background: "rgba(39,174,96,0.25)" },
                jpy:    { border: "#8E44AD", background: "rgba(142,68,173,0.25)" },
                goldKr: { border: "#F39C12", background: "rgba(243,156,18,0.25)" },
                goldGl: { border: "#D35400", background: "rgba(211,84,0,0.25)" },
                wti:    { border: "#16A085", background: "rgba(22,160,133,0.25)" },
                dubai:  { border: "#7F8C8D", background: "rgba(127,140,141,0.25)" }
            };

            // Ï∞®Ìä∏ ÏÉùÏÑ±
            const chartMap = {};

            function createChart(id) {
                const ctx = document.getElementById(id).getContext("2d");
                const data = convertData(datasets[id]);
                const now = new Date();
                const from = new Date();
                from.setMonth(now.getMonth() - 3);

                return new Chart(ctx, {
                    type:"line",
                    data:{
                        datasets:[{
                            label:labels[id],
                            data:data,
                            borderColor: colors[id].border,
                            backgroundColor: colors[id].background,
                            tension:0.1,
                            fill:true,
                            pointRadius:0
                        }]
                    },
                    options:{
                        responsive:true,
                        maintainAspectRatio:false,
                        scales:{
                            x:{
                                type:"time",
                                time:{
                                    unit:"day",
                                    tooltipFormat:"yyyy-MM-dd",
                                    displayFormats:{day:"yyyy-MM-dd"}
                                },
                                min:from,
                                max:now,
                                grid:{display:false}
                            },
                            y:{
                                grid:{display:false},
                                ticks:{
                                    callback:v => usdSet[id]
                                        ? "$"+v.toLocaleString()
                                        : v.toLocaleString()+"Ïõê"
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false },

                            tooltip: {
                                enabled: true,
                                mode: "nearest",        // Í∞ÄÍπåÏö¥ ÏßÄÏ†ê ÏûêÎèô ÏÑ†ÌÉù
                                intersect: false,       // ÏÑ† Í∑ºÏ≤òÎßå Í∞ÄÎèÑ Î∞úÎèô
                                backgroundColor: "rgba(0,0,0,0.75)",
                                titleColor: "#fff",
                                bodyColor: "#fff",
                                padding: 10,
                                cornerRadius: 6,
                                displayColors: false,

                                // üî• Ìà¥ÌåÅ ÏΩúÎ∞± (Ï£ºÏù∏Îãò ÏΩîÎìú Í∑∏ÎåÄÎ°ú)
                                callbacks: {
                                    title: ctx => {
                                        const dt = new Date(ctx[0].parsed.x);
                                        return dt.toISOString().slice(0, 10); // yyyy-MM-dd
                                    },
                                    label: ctx => {
                                        const v = ctx.parsed.y.toLocaleString();
                                        return usdSet[id]
                                            ? `Close: $${v}`
                                            : `Ï¢ÖÍ∞Ä: ${v}Ïõê`;
                                    }
                                },

                                // üî•üî• ÌïµÏã¨: hover Í∞êÏßÄ Î≤îÏúÑ Ï¶ùÍ∞Ä (Ìà¥ÌåÅ Ïûò Îú®Í≤å ÌïòÎäî ÏòµÏÖò)
                                // Chart.js v4 ÏóêÏÑúÎäî ÏïÑÎûòÍ∞Ä Ï§ëÏöîÌï®
                                itemSort: undefined,
                                animation: { duration: 0 },
                                position: "nearest",
                                caretPadding: 8
                            }
                        }

                    }
                });
            }

            // Î™®Îì† Ï∞®Ìä∏ ÏÉùÏÑ±
            Object.keys(datasets).forEach(id => {
                chartMap[id] = createChart(id);
            });


            // =======================
            // Í∞úÎ≥Ñ Ï∞®Ìä∏ Í∏∞Í∞Ñ Î≥ÄÍ≤Ω
            // =======================
            document.querySelectorAll(".chart-range button").forEach(btn => {
                btn.addEventListener("click", () => {

                    const range = btn.dataset.range;
                    const target = btn.closest(".chart-range").dataset.target;
                    const chart = chartMap[target];

                    const now = new Date();
                    let from = new Date();

                    if (range === "1m") from.setMonth(now.getMonth()-1);
                    else if (range === "3m") from.setMonth(now.getMonth()-3);
                    else if (range === "6m") from.setMonth(now.getMonth()-6);
                    else if (range === "1y") from.setFullYear(now.getFullYear()-1);

                    chart.options.scales.x.min = from;
                    chart.options.scales.x.max = now;
                    chart.update();

                    // Î≤ÑÌäº active Ïä§ÌÉÄÏùº Í∞±Ïã†
                    btn.closest(".chart-range")
                        .querySelectorAll("button")
                        .forEach(b => b.classList.remove("active"));

                    btn.classList.add("active");
                });
            });

            // =======================
// ÏµúÏã† Í∞ÄÍ≤© + Îì±ÎùΩÎ•† ÌëúÏãú
// =======================
            // =======================
// ÏµúÏã† Í∞ÄÍ≤© + Îì±ÎùΩÎ•† ÌëúÏãú
// =======================
            // =======================
// ÏµúÏã† Í∞ÄÍ≤© + Îì±ÎùΩÎ•† + Í∏∞Ï§ÄÏùº ÌëúÏãú
// =======================
            Object.keys(datasets).forEach(id => {
                const list = datasets[id];
                if (!list || list.length < 2) return;

                const last = list[list.length - 1];
                const prev = list[list.length - 2];

                const lastPrice = Number(last.close);
                const prevPrice = Number(prev.close);

                const diff = lastPrice - prevPrice;
                const rate = (diff / prevPrice) * 100;

                const priceText = lastPrice.toLocaleString();
                const diffText = diff > 0 ? `+${diff.toLocaleString()}` : diff.toLocaleString();
                const rateText = rate > 0 ? `+${rate.toFixed(2)}%` : `${rate.toFixed(2)}%`;

                const tag = document.querySelector(`.latest-info[data-id="${id}"]`);
                if (!tag) return;

                const priceFormatted = usdSet[id]
                    ? `$${priceText}`
                    : `${priceText}Ïõê`;

                const arrow = diff > 0 ? "‚ñ≤" : diff < 0 ? "‚ñº" : "";

                tag.innerHTML = `
                                ${priceFormatted}
                                <span style="margin-left:6px;">
                                    ${arrow}${diffText} (${rateText})
                                </span>
                                <span style="color:#777; margin-left:10px;">
                                    [ ${last.date} ]
                                </span>
                            `;


                if (diff > 0) tag.classList.add("up");
                else if (diff < 0) tag.classList.add("down");
            });



        });
    </script>
</th:block>

</body>
</html>
