<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">

<head>
    <title>Board Register</title>
    <!-- Toast UI Editor CSS -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">

    <style>
        /* ğŸ“ ì—…ë¡œë“œ ì¹´ë“œ ì •ë ¬ ê°œì„  */
        .uploadResult {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;          /* ì¹´ë“œ ê°„ê²© */
            padding-left: 0px; /* ì™¼ìª½ ë“¤ì—¬ì“°ê¸° */
        }

        .uploadResult .card {
            flex: 0 0 calc(33.333% - 10px); /* 3ì—´ ë°°ì¹˜ ì‹œ ì •ë ¬ ê· ë“± */
            margin-bottom: 10px;             /* ì•„ë˜ìª½ ê°„ê²© */
        }
    </style>
</head>

<div layout:fragment="content">
    <div class="row mt-3">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    Board Register
                </div>
                <div class="card-body">
                    <form action="/board/register" method="post">

                        <!-- âœ… ê²Œì‹œíŒ êµ¬ë¶„ (board_gb) -->
                        <div class="input-group mb-3">
                            <span class="input-group-text">ê²Œì‹œíŒ êµ¬ë¶„</span>
                            <select name="boardGb" class="form-select" required>
                                <option value="">-- ê²Œì‹œíŒ ì„ íƒ --</option>
                                <option value="11">ğŸ“ˆ ê±°ë˜ëŸ‰ ì „ëµ</option>
                                <option value="12">ğŸ“Š ì´ë™í‰ê· ì„  ì „ëµ</option>
                                <option value="13">ğŸš€ ì‹ ê³ ê°€ / ì‹ ì €ê°€</option>
                                <option value="14">ğŸ“‰ ë³¼ë¦°ì € ë°´ë“œ</option>
                                <option value="15">âš¡ ê¸‰ë“± / ê¸‰ë½ íƒì§€</option>
                            </select>
                        </div>

                        <!-- ì œëª© -->
                        <div class="input-group mb-3">
                            <span class="input-group-text">Title</span>
                            <input type="text" name="title" class="form-control" placeholder="Title" required>
                        </div>

                        <!-- ë‚´ìš© (Toast UI Editor) -->
                        <div class="input-group mb-3">
                            <span class="input-group-text">Content</span>
                            <div id="editor" class="form-control p-0" style="height: 400px;"></div>
                            <textarea id="content" name="content" hidden></textarea>
                        </div>

                        <!-- ì‘ì„±ì -->
                        <div class="input-group mb-3">
                            <span class="input-group-text">Writer</span>
                            <input type="text" name="writer" class="form-control"
                                   th:value="${#authentication.principal.username}" readonly>
                        </div>

                        <!-- íŒŒì¼ ì—…ë¡œë“œ -->
                        <div class="input-group mb-3">
                            <span class="input-group-text">Images</span>
                            <div class="float-end uploadHidden">
                                <button type="button" class="btn btn-primary uploadFileBtn">ADD Files</button>
                            </div>
                        </div>

                        <!-- ë²„íŠ¼ ì˜ì—­ -->
                        <div class="my-4">
                            <div class="float-end">
                                <button type="submit" class="btn btn-primary submitBtn">Submit</button>
                                <button type="reset" class="btn btn-secondary">Reset</button>
                            </div>
                        </div>
                    </form>
                </div><!-- end card-body -->
            </div><!-- end card -->
        </div><!-- end col -->
    </div><!-- end row -->

    <!-- ì²¨ë¶€íŒŒì¼ ì¸ë„¤ì¼ ì˜ì—­ -->
    <div class="row mt-3">
        <div class="col">
            <div class="container-fluid d-flex uploadResult" style="flex-wrap: wrap;"></div>
        </div>
    </div>

    <!-- ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div class="modal uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="file" name="files" class="form-control" multiple>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary uploadBtn">Upload</button>
                    <button type="button" class="btn btn-outline-dark closeUploadBtn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/upload.js"></script>
</div>

<th:block layout:fragment="script">
    <!-- Toast UI Editor JS -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <script th:inline="javascript">
        const uploadModal = new bootstrap.Modal(document.querySelector(".uploadModal"));

        // ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ
        document.querySelector(".uploadFileBtn").addEventListener("click", e => {
            e.preventDefault();
            uploadModal.show();
        });

        // ì—…ë¡œë“œ ìˆ˜í–‰
        document.querySelector(".uploadBtn").addEventListener("click", e => {
            e.preventDefault();
            const formObj = new FormData();
            const files = document.querySelector("input[name='files']").files;

            for (let file of files) {
                formObj.append("files", file);
            }

            uploadToServer(formObj).then(result => {
                result.forEach(showUploadFile);
                uploadModal.hide();
            }).catch(() => uploadModal.hide());
        });

        const uploadResult = document.querySelector(".uploadResult");

        // ì—…ë¡œë“œëœ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
        function showUploadFile({uuid, fileName, link}) {
            const fullName = `${uuid}_${fileName}`;
            const ext = fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase();
            let icon = `<i class="bi bi-file-earmark-text" style="font-size:3rem;color:#6c757d;"></i>`;

            if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext))
                icon = `<img src="/view/${link}" alt="${fileName}" data-src="${fullName}" class="img-fluid">`;
            else if (ext === 'pdf')
                icon = `<i class="bi bi-file-earmark-pdf" style="font-size:3rem;color:#d9534f;"></i>`;
            else if (['xls', 'xlsx'].includes(ext))
                icon = `<i class="bi bi-file-earmark-excel" style="font-size:3rem;color:#28a745;"></i>`;
            else if (['doc', 'docx'].includes(ext))
                icon = `<i class="bi bi-file-earmark-word" style="font-size:3rem;color:#007bff;"></i>`;

            const cardHTML = `
                <div class="card col-4 mt-2">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>${fileName}</span>
                        <button class="btn-sm btn-danger" onclick="removeFile('${uuid}', '${fileName}', this)">X</button>
                    </div>
                    <div class="card-body text-center" data-src="${fullName}">
                        ${icon}
                    </div>
                </div>`;
            uploadResult.innerHTML += cardHTML;
        }

        // íŒŒì¼ ì‚­ì œ
        function removeFile(uuid, fileName, btn) {
            removeFileToServer(uuid, fileName).then(() => btn.closest(".card").remove());
        }

        // âœ… Toast UI Editor ì´ˆê¸°í™”
        const editor = new toastui.Editor({
            el: document.querySelector('#editor'),
            height: '400px',
            initialEditType: 'markdown',
            previewStyle: 'vertical'
        });

        // âœ… Submit í´ë¦­ ì‹œ
        document.querySelector(".submitBtn").addEventListener("click", e => {
            e.preventDefault();

            // 1ï¸âƒ£ ì—ë””í„° ë‚´ìš© ë°˜ì˜
            document.querySelector("#content").value = editor.getMarkdown();

            // 2ï¸âƒ£ íŒŒì¼ ì´ë¦„ hidden inputìœ¼ë¡œ ì¶”ê°€
            const uploadCards = uploadResult.querySelectorAll(".card-body");
            const hiddenDiv = document.querySelector(".uploadHidden");
            hiddenDiv.innerHTML = "";

            uploadCards.forEach(card => {
                const src = card.getAttribute("data-src");
                if (src) hiddenDiv.innerHTML += `<input type="hidden" name="fileNames" value="${src}">`;
            });

            // 3ï¸âƒ£ í¼ ì œì¶œ
            document.querySelector("form").submit();
        });
    </script>
</th:block>
