<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
    <meta charset="UTF-8">
    <title>ì§€í‘œ ì°¨íŠ¸</title>

    <link rel="stylesheet" th:href="@{/css/markdown.css}">

    <style>
        .card { margin-bottom: 0 !important; }
        .chart-container {
            position: relative;
            width: 100%;
            height: 380px;
        }

        /* ê°œë³„ ì¹´ë“œ ë‚´ ê¸°ê°„ë²„íŠ¼ */
        .chart-range .btn.active {
            background-color: #0d6efd !important;
            color: white !important;
        }

        /* 2ì—´ ê·¸ë¦¬ë“œ */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
    </style>
</head>

<body>
<div layout:fragment="content" class="container mt-4">

    <h3 class="fw-bold mb-4">ðŸ“Š ì‹œìž¥ ì§€í‘œ ì°¨íŠ¸</h3>

    <div id="extraCharts" class="grid-container">

        <!-- 8ê°œ ì°¨íŠ¸ ê³µí†µ êµ¬ì¡° -->
        <!-- KOSPI -->
        <div class="card shadow-sm">
            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                <span>KOSPI</span>
                <div class="btn-group btn-group-sm chart-range" data-target="kospi">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="kospi"></canvas>
            </div>
        </div>

        <!-- SPX -->
        <div class="card shadow-sm">
            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                <span>S&P500</span>
                <div class="btn-group btn-group-sm chart-range" data-target="spx">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="spx"></canvas>
            </div>
        </div>

        <!-- USD -->
        <div class="card shadow-sm">
            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                <span>USD</span>
                <div class="btn-group btn-group-sm chart-range" data-target="usd">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="usd"></canvas>
            </div>
        </div>

        <!-- JPY -->
        <div class="card shadow-sm">
            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                <span>JPY</span>
                <div class="btn-group btn-group-sm chart-range" data-target="jpy">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="jpy"></canvas>
            </div>
        </div>

        <!-- ê¸ˆ KR -->
        <div class="card shadow-sm">
            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                <span>ê¸ˆ(KR)</span>
                <div class="btn-group btn-group-sm chart-range" data-target="goldKr">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="goldKr"></canvas>
            </div>
        </div>

        <!-- Gold Global -->
        <div class="card shadow-sm">
            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                <span>Gold(Global)</span>
                <div class="btn-group btn-group-sm chart-range" data-target="goldGl">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="goldGl"></canvas>
            </div>
        </div>

        <!-- WTI -->
        <div class="card shadow-sm">
            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                <span>WTI</span>
                <div class="btn-group btn-group-sm chart-range" data-target="wti">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="wti"></canvas>
            </div>
        </div>

        <!-- Dubai -->
        <div class="card shadow-sm">
            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                <span>Dubai Oil</span>
                <div class="btn-group btn-group-sm chart-range" data-target="dubai">
                    <button class="btn btn-outline-primary" data-range="1m">1M</button>
                    <button class="btn btn-outline-primary active" data-range="3m">3M</button>
                    <button class="btn btn-outline-primary" data-range="6m">6M</button>
                    <button class="btn btn-outline-primary" data-range="1y">1Y</button>
                </div>
            </div>
            <div class="card-body chart-container">
                <canvas id="dubai"></canvas>
            </div>
        </div>

    </div>
</div>

<th:block layout:fragment="script">
    <script th:src="@{/js/chart/chart.umd.min.js}"></script>
    <script th:src="@{/js/chart/chartjs-adapter-date-fns.bundle.min.js}"></script>

    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", () => {

            // =======================
            // ë°ì´í„°
            // =======================
            const datasets = {
                kospi:  /*[[${kospiList}]]*/ [],
                spx:    /*[[${spxList}]]*/ [],
                usd:    /*[[${usdList}]]*/ [],
                jpy:    /*[[${jpyList}]]*/ [],
                goldKr: /*[[${goldKrList}]]*/ [],
                goldGl: /*[[${goldGlobalList}]]*/ [],
                wti:    /*[[${wtiList}]]*/ [],
                dubai:  /*[[${dubaiList}]]*/ []
            };

            const labels = {
                kospi: "KOSPI",
                spx:   "S&P500",
                usd:   "USD",
                jpy:   "JPY",
                goldKr: "ê¸ˆ(KR)",
                goldGl: "Gold(Global)",
                wti: "WTI",
                dubai: "Dubai Oil"
            };

            const usdSet = {
                kospi:false, spx:true, usd:true, jpy:true,
                goldKr:false, goldGl:true, wti:true, dubai:true
            };

            // ë‚ ì§œ ë³€í™˜
            function convertData(list) {
                return list.map(item => {
                    const [y, m, d] = item.date.split("-");
                    return {
                        x: new Date(Date.UTC(y, m - 1, d)),  // â† ë‚ ì§œ ë°€ë¦¼ í•´ê²°
                        y: Number(item.close)
                    };
                });
            }

            const colors = {
                kospi:  { border: "#2E86DE", background: "rgba(46,134,222,0.25)" },
                spx:    { border: "#E74C3C", background: "rgba(231,76,60,0.25)" },
                usd:    { border: "#27AE60", background: "rgba(39,174,96,0.25)" },
                jpy:    { border: "#8E44AD", background: "rgba(142,68,173,0.25)" },
                goldKr: { border: "#F39C12", background: "rgba(243,156,18,0.25)" },
                goldGl: { border: "#D35400", background: "rgba(211,84,0,0.25)" },
                wti:    { border: "#16A085", background: "rgba(22,160,133,0.25)" },
                dubai:  { border: "#7F8C8D", background: "rgba(127,140,141,0.25)" }
            };

            // ì°¨íŠ¸ ìƒì„±
            const chartMap = {};

            function createChart(id) {
                const ctx = document.getElementById(id).getContext("2d");
                const data = convertData(datasets[id]);
                const now = new Date();
                const from = new Date();
                from.setMonth(now.getMonth() - 3);

                return new Chart(ctx, {
                    type:"line",
                    data:{
                        datasets:[{
                            label:labels[id],
                            data:data,
                            borderColor: colors[id].border,
                            backgroundColor: colors[id].background,
                            tension:0.1,
                            fill:true,
                            pointRadius:0
                        }]
                    },
                    options:{
                        responsive:true,
                        maintainAspectRatio:false,
                        scales:{
                            x:{
                                type:"time",
                                time:{
                                    unit:"day",
                                    tooltipFormat:"yyyy-MM-dd",
                                    displayFormats:{day:"yyyy-MM-dd"}
                                },
                                min:from,
                                max:now,
                                grid:{display:false}
                            },
                            y:{
                                grid:{display:false},
                                ticks:{
                                    callback:v => usdSet[id]
                                        ? "$"+v.toLocaleString()
                                        : v.toLocaleString()+"ì›"
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false },

                            tooltip: {
                                enabled: true,
                                mode: "nearest",        // ê°€ê¹Œìš´ ì§€ì  ìžë™ ì„ íƒ
                                intersect: false,       // ì„  ê·¼ì²˜ë§Œ ê°€ë„ ë°œë™
                                backgroundColor: "rgba(0,0,0,0.75)",
                                titleColor: "#fff",
                                bodyColor: "#fff",
                                padding: 10,
                                cornerRadius: 6,
                                displayColors: false,

                                // ðŸ”¥ íˆ´íŒ ì½œë°± (ì£¼ì¸ë‹˜ ì½”ë“œ ê·¸ëŒ€ë¡œ)
                                callbacks: {
                                    title: ctx => {
                                        const dt = new Date(ctx[0].parsed.x);
                                        return dt.toISOString().slice(0, 10); // yyyy-MM-dd
                                    },
                                    label: ctx => {
                                        const v = ctx.parsed.y.toLocaleString();
                                        return usdSet[id]
                                            ? `Close: $${v}`
                                            : `ì¢…ê°€: ${v}ì›`;
                                    }
                                },

                                // ðŸ”¥ðŸ”¥ í•µì‹¬: hover ê°ì§€ ë²”ìœ„ ì¦ê°€ (íˆ´íŒ ìž˜ ëœ¨ê²Œ í•˜ëŠ” ì˜µì…˜)
                                // Chart.js v4 ì—ì„œëŠ” ì•„ëž˜ê°€ ì¤‘ìš”í•¨
                                itemSort: undefined,
                                animation: { duration: 0 },
                                position: "nearest",
                                caretPadding: 8
                            }
                        }

                    }
                });
            }

            // ëª¨ë“  ì°¨íŠ¸ ìƒì„±
            Object.keys(datasets).forEach(id => {
                chartMap[id] = createChart(id);
            });


            // =======================
            // ê°œë³„ ì°¨íŠ¸ ê¸°ê°„ ë³€ê²½
            // =======================
            document.querySelectorAll(".chart-range button").forEach(btn => {
                btn.addEventListener("click", () => {

                    const range = btn.dataset.range;
                    const target = btn.closest(".chart-range").dataset.target;
                    const chart = chartMap[target];

                    const now = new Date();
                    let from = new Date();

                    if (range === "1m") from.setMonth(now.getMonth()-1);
                    else if (range === "3m") from.setMonth(now.getMonth()-3);
                    else if (range === "6m") from.setMonth(now.getMonth()-6);
                    else if (range === "1y") from.setFullYear(now.getFullYear()-1);

                    chart.options.scales.x.min = from;
                    chart.options.scales.x.max = now;
                    chart.update();

                    // ë²„íŠ¼ active ìŠ¤íƒ€ì¼ ê°±ì‹ 
                    btn.closest(".chart-range")
                        .querySelectorAll("button")
                        .forEach(b => b.classList.remove("active"));

                    btn.classList.add("active");
                });
            });

        });
    </script>
</th:block>

</body>
</html>
