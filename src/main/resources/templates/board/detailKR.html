<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/basic.html}">

<head>
    <meta charset="UTF-8">
    <title>ì „ëµ ìƒì„¸ë³´ê¸°</title>

    <style>
        .card-box {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 1.2rem;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        table th, table td {
            vertical-align: middle;
            font-size: 0.92rem;
        }

        .header-info {
            font-size: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
<div layout:fragment="content" class="container mt-4" style="max-width:1400px;">

    <h3 class="fw-bold mb-4">ğŸ“Œ ì „ëµ ìƒì„¸ ì¡°íšŒ</h3>

    <!-- ======================= -->
    <!-- ğŸ“Œ ìƒë‹¨ ì „ëµ ì •ë³´ -->
    <!-- ======================= -->
    <div class="card-box mb-4">

        <div class="header-info">
            <span class="fw-semibold">ì „ëµëª…: </span>
            <span th:text="${strategy}"></span>
        </div>

        <div class="header-info">
            <span class="fw-semibold">í¬ì°©ì¼: </span>
            <span th:text="${date}"></span>
        </div>

        <button onclick="history.back()" class="btn btn-outline-secondary btn-sm mt-2">â† ëª©ë¡ìœ¼ë¡œ</button>
    </div>


    <!-- ======================= -->
    <!-- ğŸ“Œ ë¡œê·¸ì¸ ì‹œ ë²„íŠ¼ -->
    <!-- ======================= -->
    <div sec:authorize="isAuthenticated()" class="mb-3 d-flex align-items-center gap-3">

        <a href="/mystock/list" class="btn btn-primary btn-sm">
            â­ ë‚´ ì¢…ëª© ë³´ëŸ¬ê°€ê¸°
        </a>

        <button id="addMyStockBtn" class="btn btn-success btn-sm">
            ğŸ“Œ ì„ íƒ ì¢…ëª© ì¶”ê°€
        </button>

    </div>


    <!-- ======================= -->
    <!-- ğŸ“Œ ìƒì„¸ í…Œì´ë¸” -->
    <!-- ======================= -->
    <div class="card">
        <div class="card-header fw-semibold">í¬ì°© ì¢…ëª© ëª©ë¡</div>

        <div class="card-body">

            <table class="table table-sm table-hover text-center">

                <thead class="table-light">
                <tr>
                    <th style="width:60px;">
                        <span sec:authorize="isAuthenticated()">
                            <input type="checkbox" id="selectAll" class="form-check-input"/>
                        </span>
                    </th>

                    <th>ì¢…ëª©ì½”ë“œ</th>
                    <th>ì¢…ëª©ëª…</th>
                    <th>í˜„ì¬ê°€</th>
                    <th th:text="${priceLabel}">ì „ì¼ì¢…ê°€</th>
                    <th>ë“±ë½ë¥ </th>
                    <th>ê±°ë˜ëŸ‰</th>
                    <th th:text="${captureName}">í¬ì°©ê°’</th>
                    <th>í¬ì°©ì‹œê°„</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="dto : ${detailList}">
                    <td>
                        <span sec:authorize="isAuthenticated()">
                            <input type="checkbox"
                                   class="stock-check"
                                   th:value="${dto.code}"
                                   th:data-name="${dto.name}"
                                   th:data-price="${dto.price}"
                                   th:data-strategy="${strategy}"
                                   th:data-special="${dto.specialValue}"
                                   th:data-date="${dto.signalDate}" />
                        </span>
                    </td>

                    <td th:text="${dto.code}"></td>
                    <td th:text="${dto.name}"></td>

                    <td th:text="${#numbers.formatInteger(dto.price, 1, 'COMMA') + ' ì›'}"></td>
                    <td th:text="${#numbers.formatInteger(dto.prevClose, 1, 'COMMA') + ' ì›'}"></td>

                    <td th:text="${dto.diff + '%'}"
                        th:style="${dto.diff >= 0} ? 'color:red;' : 'color:blue;'"></td>

                    <td th:text="${#numbers.formatInteger(dto.volume, 1, 'COMMA')}"></td>

                    <td th:text="${dto.specialValue}"></td>
                    <td th:text="${dto.createdAt}"></td>
                </tr>
                </tbody>

            </table>

        </div>
    </div>

</div> <!-- container end -->


<!-- ======================= -->
<!-- ğŸ“Œ Script (fragment) -->
<!-- ======================= -->
<th:block layout:fragment="script">
    <script th:inline="javascript">

        // ğŸ“Œ í¬ì°©ì¼(date)ì„ JS ë³€ìˆ˜ë¡œ ê°€ì ¸ì˜¤ê¸°
        const captureDate = /*[[${date}]]*/ "";

        document.addEventListener("DOMContentLoaded", () => {

            const selectAll = document.getElementById("selectAll");
            if (selectAll) {
                selectAll.addEventListener("change", () => {
                    const checked = selectAll.checked;
                    document.querySelectorAll(".stock-check").forEach(chk => {
                        chk.checked = checked;
                    });
                });
            }

            // ğŸ“Œ ì„ íƒ ì¢…ëª© ì¶”ê°€
            const btn = document.getElementById("addMyStockBtn");
            if (btn) {
                btn.addEventListener("click", () => {
                    const checked = document.querySelectorAll(".stock-check:checked");

                    if (checked.length === 0) {
                        alert("ì„ íƒëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    const list = [];
                    checked.forEach(c => {
                        list.push({
                            code: c.value,
                            name: c.dataset.name,
                            strategyName: c.dataset.strategy,
                            specialValue: c.dataset.special,
                            priceAtAdd: c.dataset.price,
                            memo: c.dataset.date   // â† í¬ì°©ì¼ ê·¸ëŒ€ë¡œ ì €ì¥
                        });
                    });

                    fetch("/mystock/add", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify(list)
                    })
                        .then(res => res.json())
                        .then(() => alert("ë‚´ ì¢…ëª©ì— ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!"))
                        .catch(err => console.error(err));
                });
            }

        });

    </script>
</th:block>
</body>
</html>
