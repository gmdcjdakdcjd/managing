<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
    <meta charset="UTF-8">
    <title>ì¢…ëª© ê²€ìƒ‰</title>

    <link rel="stylesheet" th:href="@{/css/markdown.css}">

    <style>
        .momentum-grid {
            display: grid;
            grid-template-columns: 2fr 2fr;
            gap: 1rem;
            align-items: start;
        }

        .momentum-grid > .d-flex {
            align-self: flex-start;
        }

        .card {
            margin-bottom: 0 !important;
        }

        .d-flex.flex-column.gap-3 > .card + .card {
            margin-top: 0.5rem !important;
        }

        #stockChart {
            width: 100% !important;
            height: 100% !important;
            touch-action: none;
        }

        .signal-card .card-body {
            padding-top: 1.2rem !important;
            padding-bottom: 1.2rem !important;
            line-height: 1.5;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 470px;
            overflow: visible;
            cursor: grab;
        }
    </style>
</head>

<body>
<div layout:fragment="content" class="container mt-4">
    <h3 class="fw-bold mb-4">ğŸ“Š ì¢…ëª© ê²€ìƒ‰</h3>

    <!-- ğŸ” ê²€ìƒ‰ Form -->
    <form action="/board/searchStock" method="get" class="row g-2 align-items-end mb-4">
        <div class="col-md-4">
            <label for="stockName" class="form-label small fw-semibold mb-1">ì¢…ëª©ëª…</label>
            <input type="text" class="form-control" id="stockName" name="stockName"
                   placeholder="ì˜ˆ: ì‚¼ì„±ì „ì" th:value="${param.stockName}">
        </div>
        <div class="col-md-4">
            <label for="stockCode" class="form-label small fw-semibold mb-1">ì¢…ëª©ì½”ë“œ</label>
            <input type="text" class="form-control" id="stockCode" name="stockCode"
                   placeholder="ì˜ˆ: 005930" th:value="${param.stockCode}">
        </div>
        <div class="col-md-4 d-flex flex-column justify-content-end">
            <label class="form-label small fw-semibold mb-1 invisible">ê²€ìƒ‰</label>
            <button type="submit" class="btn btn-primary w-100 fw-semibold">ğŸ” ê²€ìƒ‰</button>
        </div>
    </form>

    <!-- âš ï¸ ì˜¤ë¥˜ ë©”ì‹œì§€ -->
    <div th:if="${error}" class="alert alert-warning small" th:text="${error}"></div>

    <!-- âœ… ê²€ìƒ‰ ê²°ê³¼ -->
    <div th:if="${stock != null}" class="momentum-grid">
        <!-- ğŸ“ˆ ì‹œì„¸ í…Œì´ë¸” -->
        <div class="card shadow-sm">
            <div class="card-header bg-white fw-bold">
                [[${stock.name}]] ( [[${stock.code}]] ) â€” [[${stock.marketType}]]
            </div>
            <div class="card-body p-0" style="max-height: 765px; overflow-y: auto;">
                <table class="table table-hover table-striped mb-0 text-center align-middle">
                    <thead class="table-light sticky-top" style="top: 0; z-index: 1;">
                    <tr>
                        <th>ì¼ì</th>
                        <th>ì¢…ê°€</th>
                        <th>ê±°ë˜ëŸ‰</th>
                        <th>ì‹œê°€</th>
                        <th>ê³ ê°€</th>
                        <th>ì €ê°€</th>
                    </tr>
                    </thead>

                    <tbody th:if="${priceList != null}">
                    <tr th:each="row : ${priceList}">
                        <td th:text="${row.date != null ? row.date : '-'}"></td>
                        <td th:text="${(stock.marketType == 'KOSPI' or stock.marketType == 'KOSDAQ') ? #numbers.formatInteger(row.close, 0, 'COMMA') + 'ì›' : '$' + #numbers.formatInteger(row.close, 0, 'COMMA')}"></td>
                        <td th:text="${#numbers.formatInteger(row.volume, 0, 'COMMA')}"></td>
                        <td th:text="${(stock.marketType == 'KOSPI' or stock.marketType == 'KOSDAQ') ? #numbers.formatInteger(row.open, 0, 'COMMA') + 'ì›' : '$' + #numbers.formatInteger(row.open, 0, 'COMMA')}"></td>
                        <td th:text="${(stock.marketType == 'KOSPI' or stock.marketType == 'KOSDAQ') ? #numbers.formatInteger(row.high, 0, 'COMMA') + 'ì›' : '$' + #numbers.formatInteger(row.high, 0, 'COMMA')}"></td>
                        <td th:text="${(stock.marketType == 'KOSPI' or stock.marketType == 'KOSDAQ') ? #numbers.formatInteger(row.low, 0, 'COMMA') + 'ì›' : '$' + #numbers.formatInteger(row.low, 0, 'COMMA')}"></td>
                    </tr>
                    </tbody>

                </table>
            </div>
        </div>

        <!-- ğŸ“Š ì˜¤ë¥¸ìª½ ì°¨íŠ¸ -->
        <div class="d-flex flex-column gap-3" style="align-self:flex-start; height:auto;">
            <div class="card shadow-sm">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                    <span>ì°¨íŠ¸</span>
                    <button id="resetChartBtn" class="btn btn-outline-secondary btn-sm">ğŸ”„ ì´ˆê¸°í™”</button>
                </div>
                <div class="card-body chart-container">
                    <canvas id="stockChart"></canvas>
                </div>
            </div>


            <!-- ğŸ§­ ì¡°ê±´ í¬ì°© ì •ë³´ -->
            <div class="card shadow-sm signal-card">
                <div class="card-header bg-white fw-bold">ì¡°ê±´ í¬ì°© ì •ë³´</div>
                <div class="card-body small">
                    <div class="text-muted">
                        <span>â€» ë³¸ ì¢…ëª©ì€ ì•„ë˜ ì¡°ê±´ìœ¼ë¡œ ìë™ í¬ì°©ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
                        <div class="table-wrapper mt-2"
                             style="max-height: 160px; overflow-y: auto; border: 1px solid #ddd;">
                            <table class="table table-sm text-center mb-0">
                                <thead class="table-light"
                                       style="position: sticky; top: 0; background: #f8f9fa; z-index: 2;">
                                <tr>
                                    <th>ì „ëµëª…</th>
                                    <th>í¬ì°©ì¼</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="info : ${signalList}">
                                    <td th:text="${info.strategyName}"></td>
                                    <td th:text="${info.signalDate}"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

</div>

<!-- âœ… ScriptëŠ” í•­ìƒ body ì œì¼ ì•„ë˜ -->
<th:block layout:fragment="script">

    <!-- âœ… Chart.js + Adapter + Zoom í”ŒëŸ¬ê·¸ì¸ (ë¡œì»¬ ë²„ì „) -->
    <script th:src="@{/js/chart/chart.umd.min.js}"></script>
    <script th:src="@{/js/chart/chartjs-adapter-date-fns.bundle.min.js}"></script>
    <script th:src="@{/js/chart/chartjs-plugin-zoom.min.js}"></script>

    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", () => {
            console.log("âœ… ì¢…ëª© ê²€ìƒ‰ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰");

            // âœ… ì‹œì¥ êµ¬ë¶„ ê°’ (Thymeleafì—ì„œ ì•ˆì „í•˜ê²Œ ì¸ë¼ì¸ ì²˜ë¦¬)
            const marketType = /*[[${stock != null ? (stock.marketType != null ? "'" + stock.marketType + "'" : "null") : "null"}]]*/ null;

            // âœ… Fallback ë°©ì–´ ë¡œì§ (ë Œë”ë§ì´ ì•ˆ ëì„ ê²½ìš°ë§Œ ê¸°ë³¸ê°’ ë¶€ì—¬)
            const resolvedMarket = marketType?.replaceAll("'", "") || "KOSPI";
            console.log("âœ… ì‹œì¥ êµ¬ë¶„:", resolvedMarket);

            const rows = document.querySelectorAll("table.table tbody tr");
            if (!rows.length) return;

            const priceData = Array.from(rows).map(row => {
                const tds = row.querySelectorAll("td");
                const dateText = tds[0]?.innerText?.trim();
                const closeText = tds[1]?.innerText?.replace(/[^0-9]/g, "");
                if (!dateText || !closeText) return null;
                const [y, m, d] = dateText.split(/[.\-]/).map(Number);
                return { x: new Date(y, m - 1, d), y: Number(closeText) };
            }).filter(p => p && !isNaN(p.y));

            console.log("âœ… ì¶”ì¶œëœ priceData:", priceData);

            const ctx = document.getElementById("stockChart").getContext("2d");

            let minDate, maxDate;
            if (priceData.length > 0) {
                const timestamps = priceData
                    .map(p => p.x instanceof Date ? p.x.getTime() : new Date(p.x).getTime())
                    .filter(t => !isNaN(t));

                minDate = new Date(Math.min(...timestamps));
                maxDate = new Date(Math.max(...timestamps));

                console.log("âœ… ë°ì´í„° ë²”ìœ„ ê³„ì‚° ì™„ë£Œ");
            } else {
                console.warn("âš ï¸ priceData ë¹„ì–´ ìˆìŒ â€” min/max ê³„ì‚° ìŠ¤í‚µ");
            }

            console.log("âœ… ë°ì´í„° ë²”ìœ„:", minDate, "ë¶€í„°", maxDate, "ê¹Œì§€");
            console.log("ğŸ” priceData ìƒ˜í”Œ:", priceData.slice(0, 5));

            // âœ… ì°¨íŠ¸ ìƒì„±
            const chart = new Chart(ctx, {
                type: "line",
                data: {
                    datasets: [{
                        label: "ì¢…ê°€",
                        data: priceData,
                        borderColor: "rgba(75,192,192,1)",
                        backgroundColor: "rgba(75,192,192,0.2)",
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: "time",
                            time: {
                                unit: "day",
                                tooltipFormat: "yyyy-MM-dd",        // íˆ´íŒì— í‘œì‹œë  í˜•ì‹
                                displayFormats: { day: "yyyy-MM-dd" } // Xì¶• ëˆˆê¸ˆ(label)ì— í‘œì‹œë  í˜•ì‹
                            },
                            grid: { display: false },
                            min: (() => {
                                const now = new Date();
                                const monthAgo = new Date(now);
                                monthAgo.setMonth(now.getMonth() - 1);
                                return monthAgo;
                            })(),
                            max: new Date()
                        },
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function (value) {
                                    // âœ… ì‹œì¥ êµ¬ë¶„ì— ë”°ë¥¸ í™”í ë‹¨ìœ„ ì²˜ë¦¬
                                    if (resolvedMarket === "KOSPI" || resolvedMarket === "KOSDAQ") {
                                        return value.toLocaleString() + "ì›";
                                    } else {
                                        return "$" + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: "x",
                                modifierKey: "shift"
                            },
                            zoom: {
                                wheel: { enabled: true, speed: 0.1 },
                                pinch: { enabled: true },
                                mode: "x"
                            },
                            limits: {
                                x: { max: "original", min: minDate }
                            }
                        }
                    }
                }
            });

            // âœ… ë”ë¸”í´ë¦­ ë¦¬ì…‹
            document.getElementById("stockChart")
                .addEventListener("dblclick", () => chart.resetZoom && chart.resetZoom());

            // âœ… ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì‹œ ì¤Œ/ì´ë™ ë¦¬ì…‹
            document.getElementById("resetChartBtn")
                ?.addEventListener("click", () => chart.resetZoom && chart.resetZoom());
        });
    </script>

</th:block>
</body>
</html>
