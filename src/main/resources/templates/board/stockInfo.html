<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
    <meta charset="UTF-8">
    <title>ì¢…ëª© ê²€ìƒ‰</title>

    <link rel="stylesheet" th:href="@{/css/markdown.css}">

    <style>
        .momentum-grid {
            display: grid;
            grid-template-columns: 2fr 2fr;
            gap: 1rem;
            align-items: start;
        }

        .momentum-grid > .d-flex {
            align-self: flex-start;
        }

        .card {
            margin-bottom: 0 !important;
        }

        .d-flex.flex-column.gap-3 > .card + .card {
            margin-top: 0.5rem !important;
        }

        #stockChart {
            width: 100% !important;
            height: 100% !important;
            touch-action: none;
        }

        .signal-card .card-body {
            padding-top: 1.2rem !important;
            padding-bottom: 1.2rem !important;
            line-height: 1.5;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 470px;
            overflow: visible;
            cursor: default !important; /* ğŸ”¥ grab ëŒ€ì‹  ê¸°ë³¸ í™”ì‚´í‘œë¡œ ê³ ì • */
        }

        .range-selector {
            gap: 0.4rem; /* âœ… ë²„íŠ¼ ì‚¬ì´ ì‚´ì§ ì—¬ìœ  */
        }

        .range-selector .btn {
            border-radius: 6px !important; /* âœ… ë‘¥ê¸€ê²Œ */
            padding: 0.35rem 0.7rem; /* âœ… ì‚´ì§ ì—¬ìœ  ìˆëŠ” íŒ¨ë”© */
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }

        .range-selector .btn:hover {
            background-color: #0d6efd;
            color: white;
        }

        .range-selector .btn.active {
            background-color: #0d6efd !important;
            color: white !important;
            border-color: #0d6efd !important;
            box-shadow: 0 0 5px rgba(13, 110, 253, 0.4);
        }

    </style>
</head>

<body>
<div layout:fragment="content" class="container mt-4">
    <h3 class="fw-bold mb-4">ğŸ“Š ì¢…ëª© ê²€ìƒ‰</h3>

    <!-- ğŸ” ê²€ìƒ‰ Form -->
    <form action="/board/searchStock" method="get" class="row g-2 align-items-end mb-4">
        <div class="col-md-4">
            <label for="stockName" class="form-label small fw-semibold mb-1">ì¢…ëª©ëª…</label>
            <input type="text" class="form-control" id="stockName" name="stockName"
                   placeholder="ì˜ˆ: ì‚¼ì„±ì „ì" th:value="${param.stockName}">
        </div>
        <div class="col-md-4">
            <label for="stockCode" class="form-label small fw-semibold mb-1">ì¢…ëª©ì½”ë“œ</label>
            <input type="text" class="form-control" id="stockCode" name="stockCode"
                   placeholder="ì˜ˆ: 005930" th:value="${param.stockCode}">
        </div>
        <div class="col-md-4 d-flex flex-column justify-content-end">
            <label class="form-label small fw-semibold mb-1 invisible">ê²€ìƒ‰</label>
            <button type="submit" class="btn btn-primary w-100 fw-semibold">ğŸ” ê²€ìƒ‰</button>
        </div>
    </form>

    <!-- âš ï¸ ì˜¤ë¥˜ ë©”ì‹œì§€ -->
    <div th:if="${error}" class="alert alert-warning small" th:text="${error}"></div>

    <!-- âœ… ê²€ìƒ‰ ê²°ê³¼ -->
    <div th:if="${stock != null}" class="momentum-grid">
        <!-- ğŸ“ˆ ì‹œì„¸ í…Œì´ë¸” -->
        <div class="card shadow-sm">
            <div class="card-header bg-white fw-bold">
                [[${stock.name}]] ( [[${stock.code}]] ) â€” [[${stock.marketType}]]
            </div>
            <div class="card-body p-0" style="max-height: 765px; overflow-y: auto;">
                <table class="table table-hover table-striped mb-0 text-center align-middle">
                    <thead class="table-light sticky-top" style="top: 0; z-index: 1;">
                    <tr>
                        <th>ì¼ì</th>
                        <th>ì¢…ê°€</th>
                        <th>ê±°ë˜ëŸ‰</th>
                        <th>ì‹œê°€</th>
                        <th>ê³ ê°€</th>
                        <th>ì €ê°€</th>
                    </tr>
                    </thead>

                    <tbody th:if="${priceList != null}">
                    <tr th:each="row : ${priceList}">
                        <td th:text="${row.date != null ? row.date : '-'}"></td>
                        <td th:text="${(stock.marketType == 'KOSPI' or stock.marketType == 'KOSDAQ') ? #numbers.formatInteger(row.close, 0, 'COMMA') + 'ì›' : '$' + #numbers.formatInteger(row.close, 0, 'COMMA')}"></td>
                        <td th:text="${#numbers.formatInteger(row.volume, 0, 'COMMA')}"></td>
                        <td th:text="${(stock.marketType == 'KOSPI' or stock.marketType == 'KOSDAQ') ? #numbers.formatInteger(row.open, 0, 'COMMA') + 'ì›' : '$' + #numbers.formatInteger(row.open, 0, 'COMMA')}"></td>
                        <td th:text="${(stock.marketType == 'KOSPI' or stock.marketType == 'KOSDAQ') ? #numbers.formatInteger(row.high, 0, 'COMMA') + 'ì›' : '$' + #numbers.formatInteger(row.high, 0, 'COMMA')}"></td>
                        <td th:text="${(stock.marketType == 'KOSPI' or stock.marketType == 'KOSDAQ') ? #numbers.formatInteger(row.low, 0, 'COMMA') + 'ì›' : '$' + #numbers.formatInteger(row.low, 0, 'COMMA')}"></td>
                    </tr>
                    </tbody>

                </table>
            </div>
        </div>

        <!-- ğŸ“Š ì˜¤ë¥¸ìª½ ì°¨íŠ¸ -->
        <div class="d-flex flex-column gap-3" style="align-self:flex-start; height:auto;">
            <div class="card shadow-sm">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                    <span>ì°¨íŠ¸</span>
                    <div class="btn-group btn-group-sm range-selector" role="group" aria-label="ê¸°ê°„ ì„ íƒ">
                        <button class="btn btn-outline-primary" data-range="1m">1ê°œì›”</button>
                        <button class="btn btn-outline-primary" data-range="3m">3ê°œì›”</button>
                        <button class="btn btn-outline-primary" data-range="6m">6ê°œì›”</button>
                        <button class="btn btn-outline-primary" data-range="1y">1ë…„</button>
                    </div>
                </div>

                <div class="card-body chart-container">
                    <canvas id="stockChart"></canvas>
                </div>
            </div>


            <!-- ğŸ§­ ì¡°ê±´ í¬ì°© ì •ë³´ -->
            <div class="card shadow-sm signal-card">
                <div class="card-header bg-white fw-bold">ì¡°ê±´ í¬ì°© ì •ë³´</div>
                <div class="card-body small">
                    <div class="text-muted">
                        <span>â€» ë³¸ ì¢…ëª©ì€ ì•„ë˜ ì¡°ê±´ìœ¼ë¡œ ìë™ í¬ì°©ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
                        <div class="table-wrapper mt-2"
                             style="max-height: 160px; overflow-y: auto; border: 1px solid #ddd;">
                            <table class="table table-sm text-center mb-0">
                                <thead class="table-light"
                                       style="position: sticky; top: 0; background: #f8f9fa; z-index: 2;">
                                <tr>
                                    <th>ì „ëµëª…</th>
                                    <th>í¬ì°©ì¼</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="info : ${signalList}">
                                    <td th:text="${info.action}"></td>
                                    <td th:text="${info.signalDate}"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

</div>

<!-- âœ… ScriptëŠ” í•­ìƒ body ì œì¼ ì•„ë˜ -->
<th:block layout:fragment="script">

    <!-- âœ… Chart.js + Adapter + Zoom í”ŒëŸ¬ê·¸ì¸ (ë¡œì»¬ ë²„ì „) -->
    <script th:src="@{/js/chart/chart.umd.min.js}"></script>
    <script th:src="@{/js/chart/chartjs-adapter-date-fns.bundle.min.js}"></script>
    <script th:src="@{/js/chart/chartjs-plugin-zoom.min.js}"></script>

    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", () => {
            console.log("âœ… ì¢…ëª© ê²€ìƒ‰ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰");

            const marketType = /*[[${stock != null ? (stock.marketType != null ? "'" + stock.marketType + "'" : "null") : "null"}]]*/ null;
            const resolvedMarket = marketType?.replaceAll("'", "") || "KOSPI";
            console.log("âœ… ì‹œì¥ êµ¬ë¶„:", resolvedMarket);

            const rows = document.querySelectorAll("table.table tbody tr");
            if (!rows.length) return;

            const priceData = Array.from(rows).map(row => {
                const tds = row.querySelectorAll("td");
                const dateText = tds[0]?.innerText?.trim();
                const closeText = tds[1]?.innerText?.replace(/[^0-9]/g, "");
                if (!dateText || !closeText) return null;
                const [y, m, d] = dateText.split(/[.\-]/).map(Number);
                //return { x: new Date(y, m - 1, d), y: Number(closeText) };
                return {
                    x: new Date(Date.UTC(y, m - 1, d)),
                    y: Number(closeText)
                };
            }).filter(p => p && !isNaN(p.y));

            const ctx = document.getElementById("stockChart").getContext("2d");

            let minDate, maxDate;
            if (priceData.length > 0) {
                const timestamps = priceData.map(p => p.x.getTime()).filter(t => !isNaN(t));
                minDate = new Date(Math.min(...timestamps));
                maxDate = new Date(Math.max(...timestamps));
            }

            // âœ… ê¸°ë³¸ í‘œì‹œ ë²”ìœ„: ìµœê·¼ 3ê°œì›”
            const now = new Date();
            const defaultMin = new Date(now);
            defaultMin.setMonth(now.getMonth() - 3);

            const chart = new Chart(ctx, {
                type: "line",
                data: {
                    datasets: [{
                        label: "ì¢…ê°€",
                        data: priceData,
                        borderColor: "rgba(75,192,192,1)",
                        backgroundColor: "rgba(75,192,192,0.2)",
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: "nearest",
                        intersect: false
                    },
                    scales: {
                        x: {
                            type: "time",
                            time: {
                                unit: "day",
                                tooltipFormat: "yyyy-MM-dd",
                                displayFormats: { day: "yyyy-MM-dd" }
                            },
                            grid: { display: false },
                            min: defaultMin,
                            max: now
                        },
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function (value) {
                                    return (resolvedMarket === "KOSPI" || resolvedMarket === "KOSDAQ")
                                        ? value.toLocaleString() + "ì›"
                                        : "$" + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },

                        // âœ… ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ íˆ´íŒ í‘œì‹œ
                        tooltip: {
                            enabled: true,
                            mode: "nearest",
                            intersect: false,
                            backgroundColor: "rgba(0,0,0,0.75)",
                            titleColor: "#fff",
                            bodyColor: "#fff",
                            padding: 10,
                            cornerRadius: 6,
                            displayColors: false,
                            callbacks: {
                                title: function (context) {
                                    const date = new Date(context[0].parsed.x);
                                    return date.toISOString().slice(0, 10); // yyyy-MM-dd
                                },
                                label: function (context) {
                                    const value = context.parsed.y.toLocaleString();
                                    return (resolvedMarket === "KOSPI" || resolvedMarket === "KOSDAQ")
                                        ? `ì¢…ê°€: ${value}ì›`
                                        : `Close: $${value}`;
                                }
                            }
                        }

                        // ğŸ”’ ì¤Œ/íŒ¬ ê¸°ëŠ¥ì€ ë¹„í™œì„±í™” ìƒíƒœ ìœ ì§€
                        /*
                        zoom: {
                            pan: { enabled: true, mode: "x" },
                            zoom: { wheel: { enabled: true, speed: 0.1 }, pinch: { enabled: true }, mode: "x" },
                            limits: { x: { min: new Date(minDate.getTime() + 24 * 60 * 60 * 1000), max: "original" } }
                        }
                        */
                    }
                }
            });

            // âœ… ì´ˆê¸°í™” ë²„íŠ¼ â†’ ì›ë˜(ìµœê·¼ 3ê°œì›”) ë²”ìœ„ë¡œ ë³µê·€
            document.getElementById("resetChartBtn")?.addEventListener("click", () => {
                chart.options.scales.x.min = defaultMin;
                chart.options.scales.x.max = now;
                chart.update();
            });

            // âœ… 3ê°œì›” ë²„íŠ¼ ê¸°ë³¸ í™œì„±í™”
            const defaultButton = document.querySelector('[data-range="3m"]');
            if (defaultButton) defaultButton.classList.add("active");

            // âœ… ê¸°ê°„ ë²„íŠ¼ (1M / 3M / 6M / 1Y)
            document.querySelectorAll("[data-range]").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const range = e.target.getAttribute("data-range");
                    const now = new Date();
                    let from = new Date();

                    if (range === "1m") from.setMonth(now.getMonth() - 1);
                    else if (range === "3m") from.setMonth(now.getMonth() - 3);
                    else if (range === "6m") from.setMonth(now.getMonth() - 6);
                    else if (range === "1y") from.setFullYear(now.getFullYear() - 1);

                    chart.options.scales.x.min = from;
                    chart.options.scales.x.max = now;
                    chart.update();

                    document.querySelectorAll("[data-range]").forEach(b => b.classList.remove("active"));
                    e.target.classList.add("active");
                });
            });
        });
    </script>



</th:block>
</body>
</html>
